name: Evaluate Submission

on:
  pull_request_target:
    types: [opened, synchronize]
    paths:
      - "submission/*.enc"
      - "submission/*.enc.key"

permissions:
  contents: write
  pull-requests: write

jobs:
  evaluate:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Debug trigger
      - name: Debug
        run: echo Triggered for PR ${{ github.event.pull_request.number }}

      # 2Ô∏è‚É£ Checkout PR branch (submission only)
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
          path: pr_repo

      # 3Ô∏è‚É£ Checkout MAIN branch (latest leaderboard)
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          path: main_repo
          fetch-depth: 0

      # 4Ô∏è‚É£ Checkout private repo (true labels)
      - name: Checkout private repo
        uses: actions/checkout@v4
        with:
          repository: Tasneem-Selim-Researcher/GNN_CoRA_Competition_private
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          path: private_data

      # 5Ô∏è‚É£ Setup Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: pip install pandas scikit-learn numpy cryptography

      # 6Ô∏è‚É£ Copy encrypted submission from PR branch
      - name: Copy encrypted submission files
        run: |
          cp pr_repo/submission/*.enc main_repo/
          cp pr_repo/submission/*.enc.key main_repo/

      # 7Ô∏è‚É£ Create private key file from GitHub Secret
      - name: Create private key file
        env:
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
        run: |
          cd main_repo
          echo "$PRIVATE_KEY" > private_key.pem
          chmod 600 private_key.pem

      # 8Ô∏è‚É£ Decrypt submission
      - name: Decrypt submission
        run: |
          cd main_repo
          ENC_FILE=$(ls *.enc | tail -n 1)
          KEY_FILE="$ENC_FILE.key"
          echo "Decrypting $ENC_FILE with key $KEY_FILE"
          python encryption/decrypt_submission.py "$ENC_FILE" "$KEY_FILE" decrypted_submission.csv private_key.pem

      # 9Ô∏è‚É£ Evaluate decrypted submission
      - name: Evaluate submission
        run: |
          cd main_repo
          echo "Evaluating decrypted_submission.csv"
          python evaluate.py decrypted_submission.csv "../private_data/test_labels_only.csv"

      # üîü Generate leaderboard HTML
      - name: Generate leaderboard HTML
        run: |
          cd main_repo
          python generate_leaderboard_html.py

      # 1Ô∏è‚É£1Ô∏è‚É£ Commit updated leaderboard to main
      - name: Push leaderboard to main
        run: |
          cd main_repo
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add final_leaderboard.csv final_leaderboard.html
          if ! git diff --cached --quiet; then
            git commit -m "Update leaderboard from PR #${{ github.event.pull_request.number }}"
            git pull --rebase origin main
            git push origin HEAD:main
          else
            echo "No leaderboard changes to commit"

      # 1Ô∏è‚É£2Ô∏è‚É£ Clean up sensitive files
      - name: Clean up decrypted files
        run: |
          cd main_repo
          rm -f decrypted_submission.csv
          rm -f private_key.pem
